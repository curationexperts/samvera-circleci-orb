description: Bundles and caches an app or gem.
parameters:
  bundler_version:
    type: string
    default: '2.0.1'
  ruby_version:
    type: string
  cache_version:
    type: string
    default: '1'
steps:
  # Generate md5s for any Gemfile*, and *.gemspec files to generate a unique
  # cache key representing the contents of all files.
  - run:
      name: Generate a cache key for the bundle
      command: |
        echo $(find . -type f \( -name "Gemfile*" -o -name "*.gemspec" \) -exec md5sum {} \;) >> "BUNDLE_CACHE_KEY"

  - restore_cache:
      name: Restore bundle from cache
      keys:
        - v<< parameters.cache_version >>-bundle-{{ checksum "BUNDLE_CACHE_KEY" }}-<< parameters.ruby_version >>-<< parameters.bundler_version >>
        - v<< parameters.cache_version >>-bundle-{{ checksum "BUNDLE_CACHE_KEY" }}-<< parameters.ruby_version >>
        - v<< parameters.cache_version >>-bundle-{{ checksum "BUNDLE_CACHE_KEY" }}
        - v<< parameters.cache_version >>-bundle

  - run:
      name: Update bundler
      command: |
        echo 'export BUNDLER_VERSION=<< parameters.bundler_version >>' >> $BASH_ENV
        gem install bundler -v << parameters.bundler_version >>

  - run:
      name: Install dependencies
      command: bundle check || bundle install

  - save_cache:
      name: Save bundle cache
      key: v<< parameters.cache_version >>-bundle-{{ checksum "BUNDLE_CACHE_KEY" }}-<< parameters.ruby_version >>-<< parameters.bundler_version >>
      paths:
        - vendor/bundle
